apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: davtrowebdbvault
  labels:
    app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
    app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
    app.kubernetes.io/managed-by: kustomize
  annotations:
    argocd.argoproj.io/tracking-id: >-
      website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui:apps/StatefulSet:davtrowebdbvault/vault
spec:
  serviceName: vault
  replicas: 1
  selector:
    matchLabels:
      app: vault
      app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
  template:
    metadata:
      labels:
        app: vault
        app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
        app.kubernetes.io/managed-by: kustomize
        app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
        component: vault
    spec:
      serviceAccountName: vault-sa
      securityContext:
        fsGroup: 1000
        runAsUser: 100
        runAsGroup: 1000
      initContainers:
        # InitContainer: Inicjalizacja i unseal przy pierwszym starcie
        - name: vault-init
          image: hashicorp/vault:1.15.0
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Czekaj na start Vaulta
              until vault status > /dev/null 2>&1; do
                echo "Waiting for Vault to be ready..."
                sleep 2
              done

              # Sprawdź, czy już zainicjalizowany
              if vault status | grep -q "Initialized.*true"; then
                echo "Vault already initialized"
                exit 0
              fi

              echo "Initializing Vault..."
              vault operator init -key-shares=1 -key-threshold=1 -format=json > /shared/init-keys.json

              # Zapisz unseal key i root token do PVC
              UNSEAL_KEY=$(jq -r '.unseal_keys_b64[0]' /shared/init-keys.json)
              ROOT_TOKEN=$(jq -r '.root_token' /shared/init-keys.json)

              echo $UNSEAL_KEY > /shared/unseal-key.txt
              echo $ROOT_TOKEN > /shared/root-token.txt

              echo "Unsealing Vault..."
              vault operator unseal $UNSEAL_KEY

              echo "Vault initialized and unsealed"
          env:
            - name: VAULT_ADDR
              value: "http://127.0.0.1:8200"
          volumeMounts:
            - name: vault-data
              mountPath: /shared
            - name: vault-config
              mountPath: /vault/config
      containers:
        - name: vault
          image: hashicorp/vault:1.15.0
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8200
              name: http
              protocol: TCP
          env:
            - name: VAULT_LOCAL_CONFIG
              value: |
                ui = true
                disable_mlock = true

                listener "tcp" {
                  address = "0.0.0.0:8200"
                  tls_disable = true
                }

                storage "file" {
                  path = "/vault/data"
                }
            - name: VAULT_ADDR
              value: "http://127.0.0.1:8200"
            - name: VAULT_SKIP_VERIFY
              value: "true"
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          volumeMounts:
            - name: vault-data
              mountPath: /vault/data
            - name: vault-config
              mountPath: /vault/config
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    # Czekaj na klucze z InitContainer
                    while [ ! -f /vault/data/unseal-key.txt ]; do
                      echo "Waiting for unseal key..."
                      sleep 2
                    done
                    UNSEAL_KEY=$(cat /vault/data/unseal-key.txt)
                    vault operator unseal $UNSEAL_KEY || true
          readinessProbe:
            httpGet:
              path: /v1/sys/health?standbyok=true
              port: 8200
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /v1/sys/health
              port: 8200
            initialDelaySeconds: 60
            periodSeconds: 30
      volumes:
        - name: vault-config
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: vault-data
        labels:
          app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
          app.kubernetes.io/managed-by: kustomize
          app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        volumeMode: Filesystem
