apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    argocd.argoproj.io/tracking-id: >-
      website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui:apps/StatefulSet:davtrowebdbvault/vault
    kubectl.kubernetes.io/last-applied-configuration: >
      {"apiVersion":"apps/v1","kind":"StatefulSet","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui:apps/StatefulSet:davtrowebdbvault/vault"},"labels":{"app.kubernetes.io/instance":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui"},"name":"vault","namespace":"davtrowebdbvault"},"spec":{"replicas":1,"selector":{"matchLabels":{"app":"vault","app.kubernetes.io/instance":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui"}},"serviceName":"vault","template":{"metadata":{"labels":{"app":"vault","app.kubernetes.io/instance":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui","component":"vault"}},"spec":{"containers":[{"env":[{"name":"VAULT_LOCAL_CONFIG","value":"ui
      = true\ndisable_mlock = true\n\nlistener \"tcp\" {\n  address =
      \"0.0.0.0:8200\"\n  tls_disable = true\n}\n\nstorage \"file\" {\n  path =
      \"/vault/data\"\n}\n"},{"name":"VAULT_ADDR","value":"http://127.0.0.1:8200"},{"name":"VAULT_SKIP_VERIFY","value":"true"}],"image":"hashicorp/vault:1.15.0","imagePullPolicy":"IfNotPresent","lifecycle":{"postStart":{"exec":{"command":["/bin/sh","-c","#
      Czekaj na klucze z InitContainer\nwhile [ ! -f /vault/data/unseal-key.txt
      ]; do\n  echo \"Waiting for unseal key...\"\n  sleep
      2\ndone\nUNSEAL_KEY=$(cat /vault/data/unseal-key.txt)\nvault operator
      unseal $UNSEAL_KEY ||
      true\n"]}}},"livenessProbe":{"httpGet":{"path":"/v1/sys/health","port":8200},"initialDelaySeconds":60,"periodSeconds":30},"name":"vault","ports":[{"containerPort":8200,"name":"http","protocol":"TCP"}],"readinessProbe":{"httpGet":{"path":"/v1/sys/health?standbyok=true","port":8200},"initialDelaySeconds":5,"periodSeconds":5},"securityContext":{"capabilities":{"add":["IPC_LOCK"]}},"volumeMounts":[{"mountPath":"/vault/data","name":"vault-data"},{"mountPath":"/vault/config","name":"vault-config"}]}],"initContainers":[{"command":["/bin/sh","-c","set
      -e\n\n# Czekaj na start Vaulta\nuntil vault status \u003e /dev/null
      2\u003e\u00261; do\n  echo \"Waiting for Vault to be ready...\"\n  sleep
      2\ndone\n\n# Sprawdź, czy już zainicjalizowany\nif vault status | grep -q
      \"Initialized.*true\"; then\n  echo \"Vault already initialized\"\n  exit
      0\nfi\n\necho \"Initializing Vault...\"\nvault operator init -key-shares=1
      -key-threshold=1 -format=json \u003e /shared/init-keys.json\n\n# Zapisz
      unseal key i root token do PVC\nUNSEAL_KEY=$(jq -r '.unseal_keys_b64[0]'
      /shared/init-keys.json)\nROOT_TOKEN=$(jq -r '.root_token'
      /shared/init-keys.json)\n\necho $UNSEAL_KEY \u003e
      /shared/unseal-key.txt\necho $ROOT_TOKEN \u003e
      /shared/root-token.txt\n\necho \"Unsealing Vault...\"\nvault operator
      unseal $UNSEAL_KEY\n\necho \"Vault initialized and
      unsealed\"\n"],"env":[{"name":"VAULT_ADDR","value":"http://127.0.0.1:8200"}],"image":"hashicorp/vault:1.15.0","name":"vault-init","volumeMounts":[{"mountPath":"/shared","name":"vault-data"},{"mountPath":"/vault/config","name":"vault-config"}]}],"securityContext":{"fsGroup":1000,"runAsGroup":1000,"runAsUser":100},"serviceAccountName":"vault-sa","volumes":[{"emptyDir":{},"name":"vault-config"}]}},"volumeClaimTemplates":[{"metadata":{"labels":{"app.kubernetes.io/instance":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui","app.kubernetes.io/managed-by":"kustomize","app.kubernetes.io/name":"website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui"},"name":"vault-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"1Gi"}},"volumeMode":"Filesystem"}}]}}
  creationTimestamp: "2025-11-10T18:28:34Z"
  generation: 1
  labels:
    app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
  name: vault
  namespace: davtrowebdbvault
  resourceVersion: "3719878"
  uid: 966b2280-f8be-45b4-8ae2-4ad4abf1af50
spec:
  persistentVolumeClaimRetentionPolicy:
    whenDeleted: Retain
    whenScaled: Retain
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: vault
      app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
      app.kubernetes.io/managed-by: kustomize
      app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
  serviceName: vault
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: vault
        app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
        app.kubernetes.io/managed-by: kustomize
        app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
        component: vault
    spec:
      containers:
        - env:
            - name: VAULT_LOCAL_CONFIG
              value: |
                ui = true
                disable_mlock = true

                listener "tcp" {
                  address = "0.0.0.0:8200"
                  tls_disable = true
                }

                storage "file" {
                  path = "/vault/data"
                }
            - name: VAULT_ADDR
              value: http://127.0.0.1:8200
            - name: VAULT_SKIP_VERIFY
              value: "true"
          image: hashicorp/vault:1.15.0
          imagePullPolicy: IfNotPresent
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - "-c"
                  - |
                    # Czekaj na klucze z InitContainer
                    while [ ! -f /vault/data/unseal-key.txt ]; do
                      echo "Waiting for unseal key..."
                      sleep 2
                    done
                    UNSEAL_KEY=$(cat /vault/data/unseal-key.txt)
                    vault operator unseal $UNSEAL_KEY || true
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /v1/sys/health
              port: 8200
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 1
          name: vault
          ports:
            - containerPort: 8200
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /v1/sys/health?standbyok=true
              port: 8200
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          resources: {}
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /vault/data
              name: vault-data
            - mountPath: /vault/config
              name: vault-config
      dnsPolicy: ClusterFirst
      initContainers:
        - command:
            - /bin/sh
            - "-c"
            - >
              set -e


              # Czekaj na start Vaulta

              until vault status > /dev/null 2>&1; do
                echo "Waiting for Vault to be ready..."
                sleep 2
              done


              # Sprawdź, czy już zainicjalizowany

              if vault status | grep -q "Initialized.*true"; then
                echo "Vault already initialized"
                exit 0
              fi


              echo "Initializing Vault..."

              vault operator init -key-shares=1 -key-threshold=1 -format=json >
              /shared/init-keys.json


              # Zapisz unseal key i root token do PVC

              UNSEAL_KEY=$(jq -r '.unseal_keys_b64[0]' /shared/init-keys.json)

              ROOT_TOKEN=$(jq -r '.root_token' /shared/init-keys.json)


              echo $UNSEAL_KEY > /shared/unseal-key.txt

              echo $ROOT_TOKEN > /shared/root-token.txt


              echo "Unsealing Vault..."

              vault operator unseal $UNSEAL_KEY


              echo "Vault initialized and unsealed"
          env:
            - name: VAULT_ADDR
              value: http://127.0.0.1:8200
          image: hashicorp/vault:1.15.0
          imagePullPolicy: IfNotPresent
          name: vault-init
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /shared
              name: vault-data
            - mountPath: /vault/config
              name: vault-config
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsUser: 100
      serviceAccount: vault-sa
      serviceAccountName: vault-sa
      terminationGracePeriodSeconds: 30
      volumes:
        - emptyDir: {}
          name: vault-config
  updateStrategy:
    rollingUpdate:
      partition: 0
    type: RollingUpdate
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        creationTimestamp: null
        labels:
          app.kubernetes.io/instance: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
          app.kubernetes.io/managed-by: kustomize
          app.kubernetes.io/name: website-db-vault-kaf-redis-arg-kust-kyv-gra-loki-temp-pgui
        name: vault-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        volumeMode: Filesystem
      status:
        phase: Pending
status:
  availableReplicas: 0
  collisionCount: 0
  currentRevision: vault-7878c98696
  observedGeneration: 1
  replicas: 0
  updateRevision: vault-7878c98696
